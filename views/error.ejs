<h1><%= message %></h1>
<h2><%= error.status %></h2>
<pre><%= error.stack %></pre>



var createError = require('http-errors');
var express = require('express');
var path = require('path');
var cookieParser = require('cookie-parser');
var logger = require('morgan');
const fileUpload = require('express-fileupload');
const session = require('express-session');
const bodyParser = require('body-parser');
const moment = require('moment');
const ejs = require('ejs');
const passport= require('passport');
const flash= require('flash');
var passwordHash= require('password-hash');
const nodemailer = require('nodemailer');
var smtpTransport = require('nodemailer-smtp-transport');
const dotenv=require('dotenv');
const schedule = require('node-schedule');
var gulp = require('gulp');
var sonarqubeScanner = require('sonarqube-scanner');

dotenv.config();
const Profil = require('./models').profil;
const Email = require('./models').email;

gulp.task('default', function(callback) {
  sonarqubeScanner({
    serverUrl : "localhost:9000",
    token : "0d9170784cb59e155fff0cad0b676163901c0af7",
    options : {
      "sonar.organization": "my-org"
    }
  }, callback);
});


var date = new Date(2019, 4, 10, 14, 39, 0);
 
var j = schedule.scheduleJob(date, function(){

  
  return Profil
      .findAll()
      .then((profil) => console.log(profil))
      
  
});

dotenv.config();

var indexRouter = require('./routes/index');
var usersRouter = require('./routes/users');

var app = express();
var callback = passport.authenticate('node-sequelize', { failureRedirect: '/error' });  

var successLoginRedirect = function (req, res) {
  User.findById(req.user._id);

  var redirectionUrl = req.session.redirectUrl || '/auth';
  res.redirect(redirectionUrl);
};  

// view engine setup
/*app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'ejs');*/

app.set('views', __dirname + '/views'); // set express to look in this folder to render our view
app.set('view engine', 'ejs'); // configure template engine

app.use(logger('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json()); 
app.use(express.static(path.join(__dirname, 'public'))); // configure express to use public folder
app.use(fileUpload()); // configure fileupload
app.use(session({
	secret: 'aq8754hbjde45654de',
	resave: false,
	saveUninitialized: true
}));
app.use(function(req, res, next) {
  res.locals.user = req.session.user;
  next();
});
app.locals.moment = require('moment');
app.use(passport.initialize());
app.use(passport.session());
app.use(flash());
app.use('/', indexRouter);
app.use('/users', usersRouter);

//require('app/routes/index.js')(app, passport); // load our routes and pass in our app and fully configured passport

// catch 404 and forward to error handler
/*app.use(function(req, res, next) {
  next(createError(404));
});*/

app.post('/send-email', function (req, res) {
  return Profil
    .findByPk(req.body.playerid)
    .then((profil) => {
      return Email
      .create({
        subject:req.body.subject,
        to:req.body.to,
        body:req.body.body,
        Date:'test',
        heure:'test',
        envoie:'0',
        nom:profil.lastname,
        prenom:profil.firstname,
        numtel: prolfil.numtel,
        Datee:req.body.datee
      }).then(()=>{
      if (!profil) {
        process.env.NODE_TLS_REJECT_UNAUTHORIZED
  console.log(process.env.NODE_TLS_REJECT_UNAUTHORIZED);
  
  var AppConfig = {
    'sendEmailID': 'abdouhatty1@gmail.com',
    'sendEmailFromName': 'abdouhatty1@gmail.com',
    'sendEmailPassword': 'velomoteur'
    }
    res.redirect('detailss/'+ req.body.playerid);
    var transporter = nodemailer.createTransport({
      service: 'Gmail',
      host: 'smtp.gmail.com',
      port: '587',
      auth: {
          user: "abdellah.hatimy@gmail.com",
          pass: "Velomoteur1!"
      },
      secureConnection: 'false',
      tls: {
          ciphers: 'SSLv3'
      },
      
  });
  
  // setup e-mail data with unicode symbols 
  var mailOptions = {
      from: AppConfig.sendEmailFromName, // sender address 
      to: req.body.to, // list of receivers 
      subject: req.body.subject, // Subject line 
      html: req.body.body // html body 
  };
  
  // send mail with defined transport object 
  transporter.sendMail(mailOptions, function (error, info) {
      if (error) {
          return console.log("ERROR----" + error);
      }
      console.log('Message sent: ' + info.response);
  });
      }
    }).catch((error) => res.status(400).send(error));
    })
    .catch((error) => res.status(400).send(error));
  //console.log("HELLLO");
  
    
  });


// error handler
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});

module.exports = app;
const port = 2000;
app.listen(port, () => {
  console.log(`Server running on port: ${port}`);
});